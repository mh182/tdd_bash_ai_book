# Test Code Refactoring

Here the test code generated by ChatGPT

```bash
#!/usr/bin/env bats

# BATS test for data_download

setup() {
    # Set up test environment if needed
    # e.g., touch files, create directories, etc.
    mkdir -p tmp
}

teardown() {
    # Clean up after the tests
    rm -rf tmp
}

@test "Script prints usage when no arguments are provided" {
    run ./src/data_download
    [ "$status" -eq 1 ]
    [[ "$output" == *"Usage:"* ]]
}

@test "Script downloads data when valid URL and directory are provided" {
    run ./src/data_download -u "http://example.com/data" -d "tmp"
    [ "$status" -eq 0 ]
    [[ "$output" == *"Downloading data from http://example.com/data to tmp"* ]]
}
```

Jane identifies following possible improvements:
- The `tmp` directory is not used.
- The location of `data_download` is hardcoded in all tests in the test code.
- The test code smells - is there not a better way to write the test code?

She want to tackle the later one, since she never worked with `bats`.

Prompting ChatGPT:

> Can the provided test code be simplified? Does bats have assertions?

Answer from ChatGPT:

> Yes, the test code can be simplified using BATS built-in assertions, which make it easier to write and read tests. Instead of manually comparing exit statuses and outputs, you can use helper functions like `assert_equal`, `assert_output`, and `assert_failure` to handle common assertions.
> 
> Here’s the simplified BATS test code using assertions:
> 
> ### Simplified BATS Test (`tests/test_data_downloader.bats`):
> ```bash
> #!/usr/bin/env bats
> 
> # BATS test for data_download
> 
> setup() {
>     # Set up test environment if needed
>     mkdir -p tmp
> }
> 
> teardown() {
>     # Clean up after the tests
>     rm -rf tmp
> }
> 
> @test "Script prints usage when no arguments are provided" {
>     run /mnt/scripts/data_download
>     assert_failure  # Asserts the command failed (exit code != 0)
>     assert_output --partial "Usage:"  # Asserts that "Usage:" is part of the output
> }
> 
> @test "Script downloads data when valid URL and directory are provided" {
>     run /mnt/scripts/data_download -u "http://example.com/data" -d "tmp"
>     assert_success  # Asserts the command succeeded (exit code == 0)
>     assert_output --partial "Downloading data from http://example.com/data to tmp"
> }
> ```
> 
> ### Key Simplifications:
> 1. **`run`**: Runs the command you want to test.
>    
> 2. **`assert_success`**: Asserts that the command exited with `0` (success). This replaces `[ "$status" -eq 0 ]`.
> 
> 3. **`assert_failure`**: Asserts that the command failed (exit code is non-zero). This replaces `[ "$status" -eq 1 ]`.
> 
> 4. **`assert_output`**: Asserts that the command output contains a specific string. The `--partial` flag allows checking for substrings (e.g., "Usage:").
> 
> These assertions make the tests more readable and concise, leveraging BATS' built-in features for common patterns like checking success/failure and matching output.

Jane changes the first test as proposed by ChatGPT and runs into the following error:

```bash
✦ ❯ just test
# Use the selected container engine to run the BATS tests
docker run --rm -it -v $(pwd):/mnt -w /mnt bats/bats:latest tests
test_data_download.bats
 ✗ Script prints usage when no arguments are provided
   (in test file tests/test_data_download.bats, line 19)
     `assert_output --partial "Usage:"' failed with status 127
   /mnt/tests/test_data_download.bats: line 19: assert_output: command not found
 ✓ Script downloads data when valid URL and directory are provided

2 tests, 1 failure

error: Recipe `test` failed on line 8 with exit code 1
```

Jane asked ChatGPT for help:

> Using the proposed code leads to an error: test_data_download.bats: line 19: assert_output: command not found
> It seems bats can't find the assert_output function

Answer from ChatGPT

> It sounds like the `bats-assert` library, which provides functions like `assert_output`, is not available in your setup by default. By default, BATS only includes basic functionality, and more advanced assertions like `assert_output`, `assert_failure`, and `assert_equal` are part of external BATS add-ons, such as `bats-assert`.
> 
> To use these assertion functions, you need to install and load the `bats-assert` library in your test files. Additionally, you may want to include `bats-support`, as it provides useful helpers that `bats-assert` relies on.
> 
> ### Steps to Fix the Issue:
> 
> 1. **Install `bats-assert` and `bats-support`**:
>    - Install the libraries as Git submodules or clone them directly into a `test/libs` directory.
>    ```bash
>    mkdir -p tests/libs
>    git clone https://github.com/bats-core/bats-support tests/libs/bats-support
>    git clone https://github.com/bats-core/bats-assert tests/libs/bats-assert
>    ```
> 
> 2. **Load the Libraries in Your BATS Test File**:
>    At the beginning of your test file (`test_data_download.bats`), load the `bats-support` and `bats-assert` libraries using `load`.
> 
>    ```bash
>    # Load the necessary libraries for assertions
>    load './libs/bats-support/load'
>    load './libs/bats-assert/load'
>    ```
> 
> 3. **Updated BATS Test with Assertions**:
>    After loading the libraries, you can use functions like `assert_output`, `assert_failure`, etc.
> 
>    ```bash
>    #!/usr/bin/env bats
> 
>    # Load the necessary libraries for assertions
>    load './libs/bats-support/load'
>    load './libs/bats-assert/load'
> 
>    @test "Script prints usage when no arguments are provided" {
>        run /mnt/scripts/data_download
>        assert_failure 1  # Asserts that the command failed with exit code 1
>        assert_output --partial "Usage:"  # Asserts that "Usage:" is part of the output
>    }
> 
>    @test "Script downloads data when valid URL and directory are provided" {
>        run /mnt/scripts/data_download -u "http://example.com/data" -d "tmp"
>        assert_success  # Asserts the command succeeded (exit code 0)
>        assert_output --partial "Downloading data from http://example.com/data to tmp"
>    }
>    ```
> 
> ### Explanation:
> - **`load`**: Loads the `bats-support` and `bats-assert` libraries so that the advanced assertion functions are available.
> - **`assert_failure 1`**: Asserts that the script exited with a failure and exit code `1`.
> - **`assert_output --partial`**: Checks that a substring is present in the output.
> 
> Once you have the `bats-assert` and `bats-support` libraries set up, the tests should work correctly.

Jane already knew that the solution provided by ChatGPT would not work. She
checked the `bats` documentation about [Docker
usage](https://bats-core.readthedocs.io/en/stable/docker-usage.html#) again and
found the right answer. She changed the setup code to use `bats_load_library`
which loads system wide libraries.

After she made those changes the two tests run again. The refactored test code
looked now good.

```bash
#!/usr/bin/env bats

# BATS test for data_download

setup() {
    # get the containing directory of this file
    # use $BATS_TEST_FILENAME instead of ${BASH_SOURCE[0]} or $0,
    # as those will point to the bats executable's location or the preprocessed file respectively
    DIR="$( cd "$( dirname "$BATS_TEST_FILENAME" )" >/dev/null 2>&1 && pwd )"
    # make executables in src/ visible to PATH
    PATH="$DIR/../src:$PATH"

    # Load the necessary libraries for assertions
    bats_load_library bats-support
    bats_load_library bats-assert
}

teardown() {
    # Nothing to be done on the clean up, yet
    :
}

@test "Script prints usage when no arguments are provided" {
    run data_download
    assert_failure 1
    assert_output --partial "Usage:"
}

@test "Script downloads data when valid URL and directory are provided" {
    run data_download -u "http://example.com/data" -d "tmp"
    assert_success
    assert_output --partial "Downloading data from http://example.com/data to tmp"
}
```

Jane is satisfied with the refactored test code. Now she is finally ready to
implement the happy path for functionality requested by her boss.

